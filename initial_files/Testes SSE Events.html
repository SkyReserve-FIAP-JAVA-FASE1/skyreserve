<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva de Assento</title>
    <style>
		body {
			font-family: Arial, sans-serif;
			background-color: #f4f4f4;
			margin: 0;
			padding: 0;
			display: flex;
			justify-content: center;
			align-items: center;
			height: 100vh; /* Ocupar toda a altura da tela */
		}

		.container {
			background-color: white;
			border-radius: 10px;
			padding: 20px;
			width: 100vw; /* Ocupar toda a largura da tela */
			height: 100vh; /* Ocupar toda a altura da tela */
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			overflow: auto; /* Adiciona scroll se necessário */
			display: flex;
			flex-direction: column; /* Flexbox para organizar elementos na coluna */
			justify-content: center; /* Centraliza verticalmente */
		}

		h1 {
			text-align: center;
		}

		.airplane {
			display: grid;
			grid-template-columns: repeat(4, 1fr); /* Limita a 4 colunas */
			gap: 10px;
			justify-items: center;
			margin: 20px 0;
			overflow:auto;
		}

		.seat {
			width: 100px; /* Aumenta o tamanho do assento */
			height: 100px; /* Aumenta o tamanho do assento */
			background-color: #b9b9b9;
			border-radius: 5px;
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			font-size: 20px; /* Aumenta o tamanho da fonte */
			color: white; /* Cor do texto */
		}

		.seat.selected {
			background-color: #67c667;
		}

		.seat.occupied {
			background-color: #e57c7c;
			cursor: not-allowed;
		}

		.seat:hover:not(.occupied) {
			background-color: #2a612a;
		}

		.legend {
			display: flex;
			justify-content: space-around;
			margin-top: 20px;
		}

		.legend-item {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.legend .seat {
			margin: 0;
		}

		.reserve-button {
			width: 100%;
			padding: 15px; /* Aumenta o espaço do botão */
			font-size: 22px; /* Aumenta o tamanho da fonte do botão */
			background-color: #28a745;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			text-align: center;
			margin-top: 20px; /* Adiciona espaço acima do botão */
		}

		.reserve-button:disabled {
			background-color: #999;
			cursor: not-allowed;
		}

		.svg-container {
			display: flex;
			justify-content: center;
			margin-bottom: 20px;
		}

		/* Media queries para ajuste em telas menores */
		@media (max-width: 600px) {
			.seat {
				width: 60px; /* Diminuir tamanho do assento em telas menores */
				height: 60px;
				font-size: 16px; /* Diminuir tamanho da fonte */
			}
			
			.airplane {
				grid-template-columns: repeat(4, 1fr); /* Mantém 4 colunas em telas menores */
			}
		}

    </style>
</head>
<body>

    <div class="container">
	
        <div class="airplane" id="conteudo"></div>

        <button onclick="finalizar()" class="reserve-button" id="reserveButton" disabled>Reservar Assento</button>
		
		
    </div>

    <script>
        var seats = document.querySelectorAll('.seat:not(.occupied)');
        var reserveButton = document.getElementById('reserveButton');
        let selectedSeat = null;
        var conteudo = '';
		
		// Função chamada ao carregar a página
        window.onload = async function() {
            try {
                const response = await fetch('http://localhost:8080/assento/');
                const dataLoad = await response.json();
				for (var i = 0; i < dataLoad.length; i++) {
					preencherAssentoIniciando(JSON.stringify(dataLoad[i]));
				}
            } catch (error) {
                console.error('Erro ao buscar os assentos:', error);
            }
        };
		
		function preencherAssentoIniciando(jsonstr){
            var json = JSON.parse(jsonstr.toString());
            console.log(json);
            conteudo = conteudo + '';
            document.getElementById('conteudo').innerHTML = '';

            if(json.reservado) 
                conteudo = conteudo + '<div onclick="assentoocupado(\''+json.id+'\');" class="seat occupied" id="'+json.id+'">'+ json.nome +'</div>';
            else
                conteudo = conteudo + '<div onclick="reservar(\''+json.id+'\');" class="seat selected" id="'+json.id+'">'+ json.nome +'</div>';
            
            document.getElementById('conteudo').innerHTML = conteudo;
		}

        // Evento de clique para seleção de assentos
        seats.forEach(seat => {
            seat.addEventListener('click', () => {
                if (selectedSeat) {
                    selectedSeat.classList.remove('selected');
                }
                seat.classList.add('selected');
                selectedSeat = seat;

                // Habilitar botão de reserva
                reserveButton.disabled = false;
            });
        });

        // Evento de clique no botão de reserva
        reserveButton.addEventListener('click', () => {
            if (selectedSeat) {
                alert(`Assento ${selectedSeat.id} reservado com sucesso!`);
                selectedSeat.classList.add('occupied');
                selectedSeat.classList.remove('selected');
                selectedSeat.removeEventListener('click', null);
                reserveButton.disabled = true;
                selectedSeat = null;
            }
        });

        function assentoocupado(assento){
            alert('O Assento '+assento+' está ocupado');
            reserveButton.disabled = true;
        }

        function reservar(nome){
            reserveButton.disabled = false;
        }

        function finalizar(){
            alert('O assento está livre para reservar.');
        }

        // ::::::::::: PREENCHIMENTO PÁGINA :::::::::::
        function preencherpagina(jsonstr){
			atualizarAssentos(jsonstr);
        }
		
		// Criar a conexão com o endpoint do SSE
        const eventSource = new EventSource('http://localhost:8080/assento/stream');

        // Função para tratar as mensagens recebidas
        eventSource.onmessage = function(event) {
            // Atualizar a exibição da página conforme os dados recebidos do SSE
			preencherpagina(event.data);
        };

        // Função para tratar erros na conexão SSE
        eventSource.onerror = function(error) {
            console.error('Erro SSE:', error);
            const outputDiv = document.getElementById('conteudo');
            outputDiv.innerHTML += `<p style="color: red;">Erro na conexão com SSE</p>`;
        };

		
		// Função que percorre todas as divs e atualiza, cria ou remove conforme necessário
		function atualizarAssentos(data) {
			var dataLoad = JSON.parse(data.toString());
			var assento = dataLoad;
				
			const conteudoDiv = document.getElementById('conteudo');
			const assentosAtuais = Array.from(conteudoDiv.children).map(div => div.id);
			console.log(assentosAtuais)
			if (!assentosAtuais.includes(assento.id)) {
				// Se não existe a div, cria uma nova
				const novoAssentoDiv = document.createElement('div');
				novoAssentoDiv.id = assento.id;
				novoAssentoDiv.innerHTML = !assento.reservado
					? `<div onclick="reservar('${assento.id}');" class="seat selected">${assento.nome}</div>`
					: `<div onclick="assentoocupado('${assento.id}');" class="seat occupied">${assento.nome}</div>`;
				conteudoDiv.appendChild(novoAssentoDiv);
			} else {
				// Se a div já existe, atualiza o estado
				const divExistente = document.getElementById(assento.id);
				if (!assento.reservado) {
					divExistente.innerHTML = `<div onclick="reservar('${assento.id}');" class="seat selected">${assento.nome}</div>`;
				} else {
					divExistente.innerHTML = `<div onclick="assentoocupado('${assento.id}');" class="seat occupied">${assento.nome}</div>`;
				}
			}
				

			// Remove assentos que não estão mais na lista
			assentosAtuais.forEach(assentoId => {
				if (dataLoad.id == assentoId) {
					const divParaRemover = document.getElementById(assentoId);
					if (divParaRemover) {
						conteudoDiv.removeChild(divParaRemover);
					}
				}
			});
		}


    </script>
</body>
</html>
